#!/bin/bash
# diff to fuzzy backup file
function pushback {
	for f in $@; do
		if [ -f "$f" ] ; then back="$back $f"; fi
	done
}
function pushbackt {
	for f in $@; do
		pushback $f{,~,.~*~} # fname fname~ fname.~*~
	done
}
usage() { cat <<EOF
$*

Usage:
    backdiff [options] FILE [-diff-options] # diff BACKUP FILE -diff-options

BACKUP:
    FILE~ FILE.~*~ FILE.bak FILE.orig FILE.save
    ~/orig/FILE ~/save/FILE ~/backup/FILE
    ./orig/FILE ./save/FILE

options:
    --help, -h, -?  show help
EOF
}
help_exit() {
	usage "diff SELECTED-BACKUP FILE."
	exit 0
}
error_exit() {
	usage $1 >&2
	exit 1
}
# parse command line
case $1 in
--help|-h|-\?|"") help_exit;;
esac
base=${1##*/} # BASE.EXT
noext=${1%.*} # DIR/BASE
dir=${1%/*}   # DIR

pushback $1{~,.~*~}		# fname~ fname.~*~
pushbackt $1.{bak,orig,save}	# fname.bak fname.orig fname.save
if [ ${noext:-$1} != $1 ] ; then
	pushbackt $noext.{bak,orig,save}
fi
if [ -n "$base" ] ; then
	pushbackt ~/{orig,save,backup}/$base
	if [ "$PWD" != "$HOME" ] ; then
		pushbackt ./{orig,save}/$base
	fi
	if [ -d "$dir" ] ; then
		pushbackt $dir/{orig,save}/$base
	fi
fi
##echo "@:[$@], base:[$base], noext:[$noext], dir:[$dir], back:[$back]"
ls -ltFG $1
ls -ltFG $back | uniq
select sel in $(ls -1t $back | uniq); do
	diff $sel $@
	exit
done
